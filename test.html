<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è®¾å¤‡ä¿¡æ¯æŸ¥è¯¢</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding: 16px;
      margin: 0;
      background-color: #fafafa;
      color: #333;
    }
    h2 {
      font-size: 1.2rem;
      margin-bottom: 12px;
    }
    input {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      font-size: 1rem;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .result-item {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    .school {
      font-size: 1rem;
      color: #555;
      margin-bottom: 8px;
    }
    .account, .password {
      font-size: 1.4rem;
      font-weight: bold;
      margin: 6px 0;
      cursor: pointer;
      user-select: none;
      color: #007aff;
    }
    .account:hover, .password:hover {
      text-decoration: underline;
    }
    .details {
      font-size: 0.85rem;
      color: #777;
      margin-top: 10px;
      display: none;
    }
    .toggle-btn {
      background: none;
      border: none;
      color: #007aff;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 8px;
      padding: 0;
      text-align: left;
    }
    .loading {
      color: #888;
    }
    #result {
      margin-top: 16px;
    }
    .device-info {
      font-size: 1rem;
      margin: 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .edit-btn {
      font-size: 0.85rem;
      padding: 4px 8px;
      background: #eee;
      color: #555;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      height: auto;
      width: auto;
    }
    .edit-btn:hover {
      background: #ddd;
    }
    .hidden {
      display: none !important;
    }
    /* æ–°å¢ï¼šä¸Šæ¬¡å¤åˆ¶æ ‡ç­¾ */
    .copied-tag {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: #4CAF50;
      color: white;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: bold;
    }
    /* æ–°å¢ï¼šå¤åˆ¶æˆåŠŸæç¤ºæ¨ªå¹… */
    #copy-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 0.95rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    #copy-toast.show {
      opacity: 1;
    }
    /* æ–°å¢ï¼šçŠ¶æ€æŒ‰é’®æ ·å¼ */
    .status-btn {
        margin-top: 8px;
        padding: 4px 8px;
        font-size: 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        color: #333;
    }
    .status-btn:hover {
        background-color: #e0e0e0;
    }
    /* æ–°å¢ï¼šçŠ¶æ€æ˜¾ç¤º */
    .status-display {
        margin-top: 8px;
        padding: 4px 8px;
        font-size: 0.8rem;
        border-radius: 4px;
        font-weight: bold;
    }
    .status-completed { background-color: #d4edda; color: #155724; }
    .status-error { background-color: #f8d7da; color: #721c24; }
    .status-warning { background-color: #fff3cd; color: #856404; }
    .status-uncompleted { background-color: #d1ecf1; color: #0c5460; }
    .status-other { background-color: #e2e3e5; color: #383d41; }

    /* æ–°å¢ï¼šæ¸…é™¤çŠ¶æ€æŒ‰é’® */
    #clearStatusBtn {
        background-color: #dc3545; /* Bootstrap danger color */
    }
    #clearStatusBtn:hover {
        background-color: #c82333;
    }
  </style>
</head>
<body>
  <div id="inputSection">
    <h2>è¯·è¾“å…¥â€œè®¾å¤‡ç¼–å·â€ï¼ˆå¦‚ï¼š2ï¼‰</h2>
    <input type="text" id="modelInput" placeholder="ä¾‹å¦‚ï¼š2" />
    <button onclick="fetchDeviceInfo()">æŸ¥è¯¢</button>
  </div>
  <div id="deviceInfoSection" class="hidden">
    <div class="device-info">
      <span>æœ¬æœºç¼–å·ä¸º <strong id="displayedModelId"></strong></span>
      <button class="edit-btn" onclick="toggleEditMode()">ä¿®æ”¹</button>
    </div>
    <!-- æ–°å¢ï¼šæ¸…é™¤çŠ¶æ€æŒ‰é’® -->
    <button id="clearStatusBtn" onclick="confirmClearStatus()">æ¸…é™¤æ‰€æœ‰çŠ¶æ€</button>
  </div>
  <div id="result"></div>
  <div id="copy-toast">å¤åˆ¶æˆåŠŸ</div>

  <script>
    let copiedFlags = {}; // ç”¨äºè·Ÿè¸ªæ¯ä¸ªè®°å½•çš„è´¦å·å’Œå¯†ç æ˜¯å¦éƒ½å·²è¢«å¤åˆ¶

    function showCopyToast() {
      const toast = document.getElementById('copy-toast');
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 1500);
    }

    function copyToClipboard(text, recordId, type) { // å¢åŠ recordIdå’Œtypeå‚æ•°
      // ä¿å­˜åˆ° localStorage
      if (type === 'account') {
        localStorage.setItem('lastCopied', JSON.stringify({ type: 'account', value: text }));
      } else if (type === 'password') {
        localStorage.setItem('lastCopied', JSON.stringify({ type: 'password', value: text }));
      }

      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showCopyToast();
          markCopied(recordId, type); // æ ‡è®°å¤åˆ¶çŠ¶æ€
        }).catch(() => {
          fallbackCopy(text, recordId, type);
        });
      } else {
        fallbackCopy(text, recordId, type);
      }
    }

    function fallbackCopy(text, recordId, type) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        showCopyToast();
        markCopied(recordId, type); // æ ‡è®°å¤åˆ¶çŠ¶æ€
      } catch (err) {
        console.error("Fallback copy failed", err);
      }
      document.body.removeChild(textarea);
    }

    function markCopied(recordId, type) {
        if (!copiedFlags[recordId]) {
            copiedFlags[recordId] = { account: false, password: false };
        }
        copiedFlags[recordId][type] = true;

        // æ£€æŸ¥æ˜¯å¦è´¦å·å’Œå¯†ç éƒ½å·²å¤åˆ¶
        if (copiedFlags[recordId].account && copiedFlags[recordId].password) {
            // å‘é€è¯·æ±‚æ ‡è®°ä¸ºå®Œæˆ
            markRecordCompleted(recordId);
        }
    }

    async function markRecordCompleted(recordId) {
        try {
            const response = await fetch('http://47.122.79.126:5233/api/mark_completed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ record_id: recordId })
            });
            if (response.ok) {
                // æ›´æ–°æœ¬åœ°æ˜¾ç¤ºçŠ¶æ€ (å¯é€‰ï¼Œä¹Ÿå¯ä»¥é‡æ–°æŸ¥è¯¢)
                const statusDiv = document.querySelector(`#status-${recordId}`);
                if (statusDiv) {
                     statusDiv.textContent = 'ä»Šæ—¥å·²ç»å®Œæˆ';
                     statusDiv.className = 'status-display status-completed';
                }
                console.log(`Record ${recordId} marked as completed.`);
            } else {
                console.error('Failed to mark record as completed:', await response.text());
            }
        } catch (err) {
            console.error('Network error marking record as completed:', err);
        }
    }

    function renderResults(data) {
      const resultEl = document.getElementById('result');
      if (!Array.isArray(data) || data.length === 0) {
        resultEl.innerHTML = '<p>æœªæ‰¾åˆ°ç›¸å…³è®¾å¤‡ä¿¡æ¯ã€‚</p>';
        return;
      }

      let lastCopied = null;
      try {
        const stored = localStorage.getItem('lastCopied');
        if (stored) lastCopied = JSON.parse(stored);
      } catch (e) {
        lastCopied = null;
      }

      resultEl.innerHTML = '';
      data.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.id = `record-${item.id}`; // ä¸ºæ¯ä¸ªè®°å½•é¡¹æ·»åŠ ID

        const school = document.createElement('div');
        school.className = 'school';
        const luRuBianHao = item.å½•å…¥ç¼–å· || '';
        const xueXiao = item.å­¦æ ¡ || 'æœªçŸ¥å­¦æ ¡';
        if (luRuBianHao) {
          school.textContent = `${luRuBianHao}ã€${xueXiao}`;
        } else {
          school.textContent = xueXiao;
        }

        const account = document.createElement('div');
        account.className = 'account';
        account.textContent = 'è´¦å·ï¼š' + (item.è´¦å· || '');
        account.onclick = () => copyToClipboard(item.è´¦å· || '', item.id, 'account');

        const password = document.createElement('div');
        password.className = 'password';
        password.textContent = 'å¯†ç ï¼š' + (item.å¯†ç  || '');
        password.onclick = () => copyToClipboard(item.å¯†ç  || '', item.id, 'password');

        const details = document.createElement('div');
        details.className = 'details';
        const otherFields = { ...item };
        delete otherFields.å­¦æ ¡;
        delete otherFields.è´¦å·;
        delete otherFields.å¯†ç ;
        delete otherFields.id; // ä¸æ˜¾ç¤ºå†…éƒ¨ID
        delete otherFields.status; // çŠ¶æ€å•ç‹¬æ˜¾ç¤º
        delete otherFields.status_color; // é¢œè‰²ç±»å•ç‹¬å¤„ç†
        let detailText = '';
        for (const [key, value] of Object.entries(otherFields)) {
          if (value !== '' && value !== null && value !== undefined) {
            detailText += `${key}ï¼š${value}\n`;
          }
        }
        details.textContent = detailText.trim();

        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-btn';
        toggleBtn.textContent = 'å±•å¼€è¯¦ç»† â–¼';
        toggleBtn.onclick = () => {
          const isVisible = details.style.display === 'block';
          details.style.display = isVisible ? 'none' : 'block';
          toggleBtn.textContent = isVisible ? 'å±•å¼€è¯¦ç»† â–¼' : 'æ”¶èµ·è¯¦ç»† â–²';
        };

        // æ˜¾ç¤ºçŠ¶æ€
        const statusDiv = document.createElement('div');
        statusDiv.id = `status-${item.id}`; // ä¸ºçŠ¶æ€divæ·»åŠ ID
        statusDiv.className = `status-display ${item.status_color || 'status-uncompleted'}`;
        statusDiv.textContent = item.status || 'æœªå®Œæˆ';

        // çŠ¶æ€æ ‡è®°æŒ‰é’® (ä»…å½“çŠ¶æ€ä¸æ˜¯'ä»Šæ—¥å·²ç»å®Œæˆ'æ—¶æ˜¾ç¤º)
        const statusBtnContainer = document.createElement('div');
        if (item.status !== 'ä»Šæ—¥å·²ç»å®Œæˆ') {
            const statusBtn = document.createElement('button');
            statusBtn.className = 'status-btn';
            statusBtn.textContent = 'æ ‡è®°å¼‚å¸¸';
            statusBtn.onclick = () => promptAndMarkStatus(item.id);
            statusBtnContainer.appendChild(statusBtn);
        }

        if (lastCopied) {
          const isMatch = (lastCopied.type === 'account' && lastCopied.value === item.è´¦å·) ||
                          (lastCopied.type === 'password' && lastCopied.value === item.å¯†ç );
          if (isMatch) {
            const tag = document.createElement('div');
            tag.className = 'copied-tag';
            tag.textContent = 'ä¸Šæ¬¡å¤åˆ¶';
            div.appendChild(tag);
          }
        }

        div.appendChild(school);
        div.appendChild(account);
        div.appendChild(password);
        div.appendChild(statusDiv);
        div.appendChild(statusBtnContainer); // æ·»åŠ æŒ‰é’®å®¹å™¨
        div.appendChild(toggleBtn);
        div.appendChild(details);
        resultEl.appendChild(div);
      });
    }

    function promptAndMarkStatus(recordId) {
        const statusOptions = [
            "å¯†ç é”™è¯¯", "è´¦å·ä¸å­˜åœ¨", "ç½‘ç»œå¼‚å¸¸", "è®¾å¤‡æ•…éšœ",
            "æ‰‹æœºæ²¡ç”µ", "éƒ¨ç½²å¼‚å¸¸", "NPSè”ç»“å¼‚å¸¸", "è´¦å·è¢«å…¶ä»–äººç™»å½•", "æ—¶é—´ä¸å¤Ÿ"
        ];
        const status = prompt(`é€‰æ‹©å¼‚å¸¸çŠ¶æ€:\n${statusOptions.join('\n')}`);
        if (status && statusOptions.includes(status)) {
            sendMarkStatusRequest(recordId, status);
        } else if (status) {
            alert("æ— æ•ˆçš„çŠ¶æ€é€‰é¡¹ï¼");
        }
    }

    async function sendMarkStatusRequest(recordId, status) {
        try {
            const response = await fetch('http://47.122.79.126:5233/api/mark_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ record_id: recordId, status: status })
            });
            if (response.ok) {
                // æ›´æ–°æœ¬åœ°æ˜¾ç¤ºçŠ¶æ€ (å¯é€‰ï¼Œä¹Ÿå¯ä»¥é‡æ–°æŸ¥è¯¢)
                const statusDiv = document.querySelector(`#status-${recordId}`);
                if (statusDiv) {
                     statusDiv.textContent = status;
                     // é‡æ–°è·å–é¢œè‰²ç±» (ä»æœåŠ¡å™¨å“åº”æˆ–æœ¬åœ°è®¡ç®—)
                     // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ ¹æ®statusè®¾ç½®
                     statusDiv.className = `status-display ${getStatusColorClass(status)}`;
                }
                console.log(`Record ${recordId} marked with status: ${status}`);
            } else {
                console.error('Failed to mark status:', await response.text());
                alert("æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
            }
        } catch (err) {
            console.error('Network error marking status:', err);
            alert("ç½‘ç»œé”™è¯¯ï¼Œæ ‡è®°å¤±è´¥ã€‚");
        }
    }

    function getStatusColorClass(status) {
        // ä¸åç«¯é€»è¾‘ä¿æŒä¸€è‡´
        const colorMap = {
            "ä»Šæ—¥å·²ç»å®Œæˆ": "status-completed",
            "å¯†ç é”™è¯¯": "status-error",
            "è´¦å·ä¸å­˜åœ¨": "status-error",
            "ç½‘ç»œå¼‚å¸¸": "status-error",
            "è®¾å¤‡æ•…éšœ": "status-error",
            "æ‰‹æœºæ²¡ç”µ": "status-warning",
            "éƒ¨ç½²å¼‚å¸¸": "status-warning",
            "NPSè”ç»“å¼‚å¸¸": "status-warning",
            "è´¦å·è¢«å…¶ä»–äººç™»å½•": "status-warning",
            "æ—¶é—´ä¸å¤Ÿ": "status-warning",
            "": "status-uncompleted",
            null: "status-uncompleted"
        };
        return colorMap[status] || "status-other";
    }


    async function fetchDeviceInfo() {
      const input = document.getElementById('modelInput');
      const modelId = input.value.trim();
      if (!modelId) {
        alert('è¯·è¾“å…¥è®¾å¤‡ç¼–å·');
        return;
      }
      localStorage.setItem('lastModelId', modelId);
      const resultEl = document.getElementById('result');
      resultEl.innerHTML = '<p class="loading">æ­£åœ¨æŸ¥è¯¢...</p>';
      try {
        const response = await fetch('http://47.122.79.126:5233/api/device', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model_id: modelId })
        });
        const data = await response.json();
        if (response.ok) {
          document.getElementById('inputSection').classList.add('hidden');
          document.getElementById('deviceInfoSection').classList.remove('hidden');
          document.getElementById('displayedModelId').textContent = modelId;
          copiedFlags = {}; // é‡ç½®å¤åˆ¶æ ‡è®°
          renderResults(data);
        } else {
          resultEl.innerHTML = `<p style="color:red;">âŒ é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
        }
      } catch (err) {
        resultEl.innerHTML = `<p style="color:red;">ğŸŒ ç½‘ç»œé”™è¯¯: ${err.message}</p><p>ğŸ’¡ è¯·ç¡®è®¤ Flask æœåŠ¡å™¨å·²å¯åŠ¨ï¼</p>`;
      }
    }

    function toggleEditMode() {
      document.getElementById('inputSection').classList.remove('hidden');
      document.getElementById('deviceInfoSection').classList.add('hidden');
      document.getElementById('result').innerHTML = '';
      const last = localStorage.getItem('lastModelId');
      if (last) {
        document.getElementById('modelInput').value = last;
      }
    }

    function confirmClearStatus() {
        const confirmation = prompt("âš ï¸ å±é™©æ“ä½œï¼\næ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰è®°å½•çš„çŠ¶æ€ã€‚\nè¯·è¾“å…¥ 'ç¡®è®¤æ¸…é™¤' ä»¥ç»§ç»­ï¼š");
        if (confirmation === "ç¡®è®¤æ¸…é™¤") {
            sendClearStatusRequest();
        } else {
            alert("æ“ä½œå·²å–æ¶ˆã€‚");
        }
    }

    async function sendClearStatusRequest() {
        try {
            const response = await fetch('http://47.122.79.126:5233/api/clear_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confirmation: "ç¡®è®¤æ¸…é™¤" })
            });
            const data = await response.json();
            if (response.ok) {
                alert(data.message);
                // æ¸…é™¤åï¼Œå¯ä»¥é‡æ–°æŸ¥è¯¢å½“å‰è®¾å¤‡ç¼–å·ä»¥åˆ·æ–°æ˜¾ç¤º
                const currentModelId = document.getElementById('displayedModelId').textContent;
                if (currentModelId) {
                    document.getElementById('modelInput').value = currentModelId;
                    await fetchDeviceInfo(); // é‡æ–°åŠ è½½æ•°æ®
                }
            } else {
                alert(`æ¸…é™¤å¤±è´¥: ${data.error}`);
            }
        } catch (err) {
            console.error('Network error clearing status:', err);
            alert("ç½‘ç»œé”™è¯¯ï¼Œæ¸…é™¤å¤±è´¥ã€‚");
        }
    }

    window.onload = () => {
      const last = localStorage.getItem('lastModelId');
      if (last) {
        document.getElementById('modelInput').value = last;
        setTimeout(fetchDeviceInfo, 300);
      }
    };
  </script>
</body>
</html>
